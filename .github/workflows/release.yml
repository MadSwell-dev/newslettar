name: Build and Release Binaries

on:
  release:
    types: [created]
  workflow_dispatch:
    inputs:
      tag:
        description: 'Release tag (e.g., v1.2.0)'
        required: true
        type: string

permissions:
  contents: write

jobs:
  build:
    name: Build binaries for ${{ matrix.os }}-${{ matrix.arch }}
    runs-on: ubuntu-latest

    strategy:
      matrix:
        include:
          - os: linux
            arch: amd64
            goarch: amd64
          - os: linux
            arch: arm64
            goarch: arm64
          - os: linux
            arch: armv6
            goarch: arm
            goarm: '6'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'

      - name: Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "VERSION=${{ inputs.tag }}" >> $GITHUB_OUTPUT
          else
            echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          fi

      - name: Build binary
        env:
          GOOS: ${{ matrix.os }}
          GOARCH: ${{ matrix.goarch }}
          GOARM: ${{ matrix.goarm }}
        run: |
          # Build with optimizations
          go build -v \
            -ldflags="-s -w -X main.Version=${{ steps.version.outputs.VERSION }}" \
            -trimpath \
            -o newslettar \
            ./cmd/newslettar

          # Verify binary was created
          ls -lh newslettar
          file newslettar

      - name: Create archive
        run: |
          ARCHIVE_NAME="newslettar_${{ steps.version.outputs.VERSION }}_${{ matrix.os }}_${{ matrix.arch }}.tar.gz"
          tar -czf "${ARCHIVE_NAME}" newslettar

          # Generate checksums
          sha256sum "${ARCHIVE_NAME}" > "${ARCHIVE_NAME}.sha256"

          echo "ARCHIVE_NAME=${ARCHIVE_NAME}" >> $GITHUB_ENV
          ls -lh "${ARCHIVE_NAME}"

      - name: Upload to release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            ${{ env.ARCHIVE_NAME }}
            ${{ env.ARCHIVE_NAME }}.sha256
          tag_name: ${{ steps.version.outputs.VERSION }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  docker:
    name: Build and push Docker image
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "VERSION=${{ inputs.tag }}" >> $GITHUB_OUTPUT
          else
            echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          fi

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: .
          platforms: linux/amd64,linux/arm64
          push: true
          tags: |
            madswell/newslettar:latest
            madswell/newslettar:${{ steps.version.outputs.VERSION }}

  build-deb:
    name: Build Debian package
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'

      - name: Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "VERSION=${{ inputs.tag }}" >> $GITHUB_OUTPUT
          else
            echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          fi

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y dpkg-dev

      - name: Build Debian package
        run: |
          if [ -f scripts/build-deb.sh ]; then
            chmod +x scripts/build-deb.sh
            bash scripts/build-deb.sh
          else
            echo "Debian build script not found, skipping"
            exit 0
          fi

      - name: Upload Debian package to release
        if: success()
        uses: softprops/action-gh-release@v1
        with:
          files: dist/*.deb
          tag_name: ${{ steps.version.outputs.VERSION }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-windows-installer:
    name: Build Windows MSI installer
    runs-on: windows-latest
    needs: build

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22.10'

      - name: Get version
        id: version
        shell: bash
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "VERSION=${{ inputs.tag }}" >> $GITHUB_OUTPUT
          else
            echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          fi

      - name: Install WiX Toolset
        shell: powershell
        run: |
          # Install WiX 3.11
          choco install wixtoolset -y --version=3.11.2 --force

          # Wait for installation to complete
          Start-Sleep -Seconds 5

      - name: Verify WiX installation and add to PATH
        shell: powershell
        run: |
          # Check multiple possible WiX installation locations (v3.14 and v3.11)
          $possiblePaths = @(
            "C:\Program Files (x86)\WiX Toolset v3.14\bin",
            "C:\Program Files (x86)\WiX Toolset v3.11\bin",
            "C:\Program Files\WiX Toolset v3.14\bin",
            "C:\Program Files\WiX Toolset v3.11\bin"
          )

          $wixPath = $null
          foreach ($path in $possiblePaths) {
            Write-Host "Checking: $path"
            if (Test-Path "$path\candle.exe") {
              $wixPath = $path
              Write-Host "[OK] WiX found at: $wixPath"
              break
            }
          }

          if (-not $wixPath) {
            Write-Host "[ERROR] WiX not found in any expected location"
            exit 1
          }

          # Add to PATH and save to environment for later steps
          echo "$wixPath" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
          echo "WIX_PATH=$wixPath" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          Write-Host "[OK] Added to PATH: $wixPath"

      - name: Install go-msi
        shell: powershell
        run: |
          # Download pre-built go-msi binary (avoids Go version compatibility issues)
          Write-Host "Downloading go-msi pre-built binary..."
          $goMsiUrl = "https://github.com/mh-cbon/go-msi/releases/download/1.0.2/go-msi-amd64.exe"
          $goMsiPath = "$env:USERPROFILE\go\bin\go-msi.exe"

          # Create directory if it doesn't exist
          New-Item -ItemType Directory -Force -Path "$env:USERPROFILE\go\bin" | Out-Null

          # Download go-msi
          Invoke-WebRequest -Uri $goMsiUrl -OutFile $goMsiPath -UseBasicParsing

          # Add to PATH
          $goPath = "$env:USERPROFILE\go\bin"
          echo "$goPath" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

          # Verify installation
          if (Test-Path $goMsiPath) {
            Write-Host "[OK] go-msi downloaded successfully"
            $fileSize = [math]::Round((Get-Item $goMsiPath).Length / 1MB, 2)
            Write-Host "Size: $fileSize MB"
          } else {
            Write-Host "[ERROR] go-msi download failed"
            exit 1
          }

      - name: Build Windows binary
        shell: powershell
        run: |
          go build `
            -ldflags="-s -w -X main.version=${{ steps.version.outputs.VERSION }}" `
            -trimpath `
            -o newslettar.exe `
            ./cmd/newslettar
          Write-Host "Binary built successfully"
          if (Test-Path newslettar.exe) {
            Write-Host "newslettar.exe exists: $((Get-Item newslettar.exe).Length / 1MB) MB"
          }

      - name: Build MSI installer
        shell: powershell
        run: |
          New-Item -ItemType Directory -Force -Path dist
          $env:PATH = "$env:WIX_PATH;$env:USERPROFILE\go\bin;$env:PATH"
          Write-Host "Using WiX from: $env:WIX_PATH"

          Write-Host "Checking for required files..."
          @("newslettar.exe", "newslettar-service.xml", "scripts/install-windows.ps1", "scripts/newslettar-ctl.bat") | ForEach-Object {
            if (Test-Path $_) {
              Write-Host "  [OK] $_"
            } else {
              Write-Host "  [MISSING] $_ - file not found"
              exit 1
            }
          }

          Write-Host "Running go-msi..."
          & "$env:USERPROFILE\go\bin\go-msi.exe" make --msi "dist/newslettar-${{ steps.version.outputs.VERSION }}-amd64.msi" --version "${{ steps.version.outputs.VERSION }}" --arch amd64

          if ($LASTEXITCODE -ne 0) {
            Write-Host "go-msi failed with exit code: $LASTEXITCODE"
            exit $LASTEXITCODE
          }

          if (Test-Path "dist/newslettar-${{ steps.version.outputs.VERSION }}-amd64.msi") {
            Write-Host "MSI created successfully: $((Get-Item dist/newslettar-${{ steps.version.outputs.VERSION }}-amd64.msi).Length / 1MB) MB"
          } else {
            Write-Host "MSI file was not created"
            exit 1
          }

      - name: Generate checksum
        shell: powershell
        run: |
          $msiFile = "dist/newslettar-${{ steps.version.outputs.VERSION }}-amd64.msi"
          $hash = (Get-FileHash -Path $msiFile -Algorithm SHA256).Hash.ToLower()
          "$hash  $(Split-Path $msiFile -Leaf)" | Out-File -FilePath "$msiFile.sha256" -Encoding ascii

      - name: Upload Windows installer to release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            dist/*.msi
            dist/*.msi.sha256
          tag_name: ${{ steps.version.outputs.VERSION }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
